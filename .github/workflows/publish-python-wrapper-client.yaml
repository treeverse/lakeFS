name: Publish Python Wrapper Client

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Python build and make package
      run: make package-python-wrapper

    - name: Publish distribution ðŸ“¦ to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.TESTPYPI_API_TOKEN }}
        packages_dir: clients/python-wrapper/dist/
        verbose: true
        repository-url: https://test.pypi.org/legacy/

    # TODO: Enable once we're ready for production
    - name: Publish distribution ðŸ“¦ to PyPI
      if: false
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: clients/python-wrapper/dist/
        verbose: true

    - name: Extract docs version
      shell: bash
      run: |
          echo "tag=$(python setup.py --version)" >> $GITHUB_OUTPUT
      id: docver

    - name: Create markdown from docstring 
      uses: ammaraskar/sphinx-action@master
      with:
        docs-folder: "docs/"
        pre-build-command: "pip install sphinx-autodoc-typehints"
        build-command: "sphinx-build -b markdown sphinx _build"

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        working-directory: clients/python-wrapper
        ruby-version: '2.7'
        bundler-cache: true # runs 'bundle install' and caches installed gems automatically

    - name: Build release as latest
      working-directory: clients/python-wrapper
      run: bundle exec jekyll build -d _site -b /

    - name: Build release ${{ steps.docver.outputs.tag }}
      working-directory: clients/python-wrapper
      run: bundle exec jekyll build -d _site/${{ steps.docver.outputs.tag }} -b /${{ steps.docver.outputs.tag }}

    - name: Publish to docs repository
      uses: dmnemec/copy_file_to_another_repo_action@v1.1.1
      env:
        API_TOKEN_GITHUB: ${{ secrets.PERSONAL_TOKEN }}
      with:
        source_file: clients/python-wrapper/_site/.
        destination_repo: treeverse/docs-lakefs-sdk-python-wrapper
        destination_folder: /
        user_email: 'support@treeverse.io'
        user_name: 'python-docs-action'

# TODO: Publish docs once we decide on documentation process
