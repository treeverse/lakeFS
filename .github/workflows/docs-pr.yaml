name: Docs Preview and Link Check

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - "docs/**"
      - ".github/workflows/docs-*.yaml"
    branches:
      - master

jobs:
  # This job name kept short because it's used in the preview URL
  preview:
    name: Docs PR - Publish preview and check links
    runs-on: ubuntu-22.04
    permissions:
          pull-requests: write
    steps:
      - name: Check-out
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        working-directory: docs
        run: pip install -r requirements-docs.txt

      - name: Build latest
        id: build-latest
        working-directory: docs
        run: mkdocs build

      - name: Overlay PR message on each page
        working-directory: docs/site
        run: |
          PR_URL=${{ github.event.pull_request.html_url }}
          PR_NUMBER=${{ github.event.pull_request.number }}

          html_files=$(find . -name '*.html')

          for file in $html_files; do
            sed -i -e "s|\(.*\)\(</body>\)|<div style=\"position: fixed; top: 5px; left: 5px; padding: 3px; background-color: #e8ac07; font-weight: bold; z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.5);\">ℹ️ This is a preview of PR <a href=\"$PR_URL\" style=\"color: black;\">#$PR_NUMBER</a></div>\n\1\2|" $file
          done
       
      - name: Publish preview site
        uses: cloudflare/wrangler-action@v3
        id: preview_step
        with:
          apiToken: ${{ secrets.CLOUDFLARE_PAGES_PR_PREVIEW }}
          command: pages deploy docs/site --project-name=lakefs-docs --branch=pr-${{ github.event.pull_request.number }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Get the preview_url
        run: echo "url => ${{ steps.preview_step.outputs.pages-deployment-alias-url }}"

      - name: Check links
        id: lychee
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: docs/site --no-progress --exclude-mail --exclude-file=.lycheeignore
          fail: true
          jobSummary: true
          format: markdown
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
