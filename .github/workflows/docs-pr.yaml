name: Docs Pull Request

on:
  pull_request:
    paths:
      - "docs/**"
    branches:
      - master

jobs:
  preview-site-and-check-links:
    name: Docs PR - Publish preview and check links
    runs-on: ubuntu-20.04
    steps:
      - name: Check-out
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1.79.0
        with:
          working-directory: docs
          ruby-version: 2.6
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically

# unclear if we need this yet
      # - name: Setup base URL env var
      #   run: |
      #     export PRNUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
      #     echo BASEURL="https://rmoff-lakefs-preview-pr-"$PRNUMBER".surge.sh/" >> $GITHUB_ENV

      - name: Build latest
        id: build-latest
        working-directory: docs
        run: bundle exec jekyll build --config _config.yml -d _site/

      - name: inspect build
        working-directory: docs
        run: |
          ls -l _site
          ls -l .
          df -h _site

      - name: Publish preview site
        uses: afc163/surge-preview@v1
        id: preview_step
        working-directory: docs
        with:
          surge_token: ${{ secrets.SURGE_TOKEN }}
          # github_token: ${{ secrets.GITHUB_TOKEN }}
          dist: _site
          failOnError: true
          teardown: true
          build: |
            echo Deploying preview to surge.sh

      - name: Get the preview_url
        run: echo "url => ${{ steps.preview_step.outputs.preview_url }}"

      # - name: Link Checker
      #   uses: untitaker/hyperlink@0.1.26
      #   with:
      #     args: docs/_site
          
