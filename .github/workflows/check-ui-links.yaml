name: Check links from the UI

on:
  pull_request:
    # paths:
    #   - "webui/**"
    #   - "docs/**"
    branches:
      - master

jobs:
  # This job name kept short because it's used in the preview URL
  preview:
    name: Check links from UI
    runs-on: ubuntu-20.04
    steps:
      - name: Check-out
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: docs
          ruby-version: '2.7'
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically

      - name: Build latest
        working-directory: docs
        run: bundle exec jekyll build --config _config.yml -d _site/ --verbose

      - name: Get links to check
        id: get-links
        run: |
          escaped_pwd=$(pwd | sed 's/[\/&]/\\&/g')
          echo $pwd
          echo $escaped_pwd
          ls -l 

          find webui/src -type f ! -name "*.js" -exec grep -Eo 'href="([^"]*)"' {} \; | \
            cut -d'"' -f2 | \
            grep -v -e "^/" -e "^#" | \
            sed "s/https:\/\/docs.lakefs.io/file:\/\/$escaped_pwd\/docs\/_site/" > /tmp/links_to_check.txt

      - name: Check links
        id: lychee
        uses: lycheeverse/lychee-action@v1.7.0
        with:
          args: /tmp/links_to_check.txt
          fail: true
          jobSummary: true
          format: markdown
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
