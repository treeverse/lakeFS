name: Check links from the UI

on:
  pull_request:
    paths:
      - "webui/**"
      - "docs/**"
    branches:
      - master

jobs:
  # This job name kept short because it's used in the preview URL
  preview:
    name: Check links from UI
    runs-on: ubuntu-20.04
    steps:
      - name: Check-out
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: docs
          ruby-version: '2.7'
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically

      - name: Build latest
        working-directory: docs
        run: bundle exec jekyll build --config _config.yml -d _site/ --verbose

      - name: Get links to check
        id: get-links
        working-directory: /
        run: |
          function search_links_in_files() {
              local folder_path="webui/src"
              find "$folder_path" -type f ! -name "*.js" -print0 | while IFS= read -r -d '' file; do
                grep -Eo 'href="([^"]*)"' "$file" | cut -d'"' -f2 | while IFS= read -r link; do
                  # echo "$link\tis linked to from\t$file"
                  echo $link
                done
              done
          }

          escaped_pwd=$(pwd | sed 's/[\/&]/\\&/g')
          search_links_in_files | \
            grep -v -e "^/" -e "^#" | \
            sed "s/https:\/\/docs.lakefs.io/file:\/\/$escaped_pwd\/docs\/_site/" > /tmp/links_to_check.txt

      - name: Check links
        id: lychee
        uses: lycheeverse/lychee-action@v1.7.0
        with:
          args: /tmp/links_to_check.txt
          fail: true
          jobSummary: true
          format: markdown
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
