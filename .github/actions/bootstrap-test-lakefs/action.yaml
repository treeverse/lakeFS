name: 'Start lakeFS for testing'
description: 'Get generated code, authenticate to ECR, and run docker compose up'
inputs:
  compose-flags:
    description: flags to add to docker compose up command
    required: false
    default: "-d"
  compose-file:
    description: alternative path to docker compose file
    required: false
  compose-directory:
    description: working directory for the docker compose step
    required: false
    default: "."
  hadoop-version:
    description: Hadoop version to download
    required: false
    default: ""
  spark-extra-classpath:
    description: The classpath for Spark
    required: false
    default: ""
runs:
  using: "composite"
  steps:
    - name: Retrieve generated code
      uses: actions/download-artifact@v4.1.8
      with:
        name: generated-code
        path: /tmp/
    - name: Unpack generated code
      shell: bash
      run: tar -xzvf /tmp/generated.tar.gz

    - name: Resolve Hadoop version & CP
      id: h
      shell: bash
      run: |
        set -euo pipefail
        ver="${{ inputs.hadoop-version }}"
        if [[ -z "$ver" ]]; then
          case "${SPARK_TAG:-3}" in
            2* ) ver="3.2.1" ;;
            *  ) ver="3.3.6" ;;
          esac
        fi
        echo "ver=$ver" >> "$GITHUB_OUTPUT"
        home="/tmp/hadoop-$ver"
        echo "home=$home" >> "$GITHUB_OUTPUT"
        
        H_HOST="$home/share/hadoop"
        H_CONT="/opt/hadoop/share/hadoop"
        
        mapfile -t JARS_HOST < <(
          find "$H_HOST/common" -maxdepth 1 -type f \
            \( -name "hadoop-common-*.jar" -o -name "hadoop-auth-*.jar" \) -print
          find "$H_HOST/aws" -maxdepth 1 -type f -name "hadoop-aws-*.jar" -print
          find "$H_HOST/common/lib" -maxdepth 1 -type f \
            \( -name "aws-java-sdk-*.jar" -o -name "aws-java-sdk-bundle-*.jar" \
               -o -name "jackson-*.jar" -o -name "http*.jar" \
               -o -name "commons-*.jar" -o -name "joda-time-*.jar" \) \
            ! -name "netty*.jar" -print
        )
        CP_CONT=""
        for p in "${JARS_HOST[@]}"; do
          p_cont="${p/$home/\/opt\/hadoop}"
          CP_CONT="${CP_CONT:+${CP_CONT}:}${p_cont}"
        done
        echo "spark_cp=$CP_CONT" >> "$GITHUB_OUTPUT"

    - name: Cache Hadoop
      uses: actions/cache@v4
      id: hadoop-cache
      with:
        path: ${{ steps.h.outputs.home }}
        key: hadoop-${{ steps.h.outputs.ver }}

    - name: Download Hadoop if missing
      if: steps.hadoop-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        set -euo pipefail
        curl -fsSL "https://archive.apache.org/dist/hadoop/common/hadoop-${{ steps.h.outputs.ver }}/hadoop-${{ steps.h.outputs.ver }}.tar.gz" \
        | tar -xz -C /tmp

    - name: Export env & write .env
      shell: bash
      run: |
        echo "HADOOP_HOME_HOST=${{ steps.h.outputs.home }}" >> "$GITHUB_ENV"
        echo "SPARK_EXTRA_CLASSPATH=${{ steps.h.outputs.spark_cp }}" >> "$GITHUB_ENV"
        printf "HADOOP_HOME_HOST=%s\nSPARK_EXTRA_CLASSPATH=%s\n" \
          "${{ steps.h.outputs.home }}" \
          "${{ steps.h.outputs.spark_cp }}" \
          > "${{ inputs.compose-directory }}/.env"


    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    - name: Start docker compose
      env:
        LAKEFS_STATS_ENABLED: "false"
        LAKEFS_GATEWAYS_S3_DOMAIN_NAME: s3.docker.lakefs.io:8000
        COMPOSE_PARALLEL_LIMIT: 1 # Workaround for https://github.com/docker/compose/issues/12747 until compose >= v2.36.0
      shell: bash
      run: |
        set -euo pipefail
        echo "HADOOP_HOME_HOST=${HADOOP_HOME_HOST:-<empty>}"
        echo "SPARK_EXTRA_CLASSPATH=${SPARK_EXTRA_CLASSPATH:-<empty>}"
        [[ -z "${{ inputs.compose-file }}" ]] && flags="" || flags="-f ${{ inputs.compose-file }}"
        docker compose --project-directory ${{ inputs.compose-directory }} ${flags} up ${{ inputs.compose-flags }}
