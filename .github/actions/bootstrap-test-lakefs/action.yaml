name: 'Start lakeFS for testing'
description: 'Get generated code, authenticate to ECR, and run docker compose up'
inputs:
  compose-flags:
    description: flags to add to docker compose up command
    required: false
    default: "-d"
  compose-file:
    description: alternative path to docker compose file
    required: false
  compose-directory:
    description: working directory for the docker compose step
    required: false
    default: "."
  detached:
    description: "Run docker compose up in detached mode (-d). Set to 'false' to run in foreground."
    required: false
    default: "true"
  wait:
    description: "When detached, wait for services to be healthy (requires healthchecks)."
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    - name: Retrieve generated code
      uses: actions/download-artifact@v4.1.8
      with:
        name: generated-code
        path: /tmp/
    - name: Unpack generated code
      shell: bash
      run: tar -xzvf /tmp/generated.tar.gz
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    - name: Start docker compose
      env:
        LAKEFS_STATS_ENABLED: "false"
        LAKEFS_GATEWAYS_S3_DOMAIN_NAME: s3.docker.lakefs.io:8000
        COMPOSE_PARALLEL_LIMIT: 1 # Workaround for https://github.com/docker/compose/issues/12747 until compose >= v2.36.0
      shell: bash
      run: |
        set -euo pipefail

        file_flags=()
        if [[ -n "${{ inputs.compose-file }}" ]]; then
          file_flags=(-f "${{ inputs.compose-file }}")
        fi

        up_flags=()
        if [[ "${{ inputs.detached }}" == "true" ]]; then
          up_flags+=(-d)
          if [[ "${{ inputs.wait }}" == "true" ]]; then
            up_flags+=(--wait)
          fi
        fi
        
        docker compose --project-directory "${{ inputs.compose-directory }}" "${file_flags[@]}" \
          up ${up_flags[*]} ${{ inputs.compose-flags }}
